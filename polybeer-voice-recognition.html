<link rel="import" href="../polymer/polymer.html">
<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<link rel="import" href="bower_components/voice-elements/dist/voice-player.html">
<link rel="import" href="bower_components/voice-elements/dist/voice-recognition.html">

<dom-module id="polybeer-voice-recognition">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
      <voice-recognition></voice-recognition>

  </template>

  <script>
      Polymer({
          is: 'polybeer-voice-recognition',
          properties: {
              continuous: {
                  type: Boolean,
                  value: false
              },
              accent: {
                  type: String,
                  value: 'en-US',
                  observer: '_accentChanged',
                  notify: true
              },
              text: {
                  type: String,
                  value: ''
              }
          },
          created: function() {
              var SpeechRecognition = window.SpeechRecognition ||
                  window.webkitSpeechRecognition ||
                  window.mozSpeechRecognition ||
                  window.msSpeechRecognition ||
                  window.oSpeechRecognition;

              if (SpeechRecognition !== undefined) {
                  this.recognition = new SpeechRecognition();
              }
              else {
                  console.error('Your browser does not support the Web Speech API');
              }
          },
          ready: function() {
              this.recognition.continuous = this.continuous;
              this.recognition.interimResults = false;

              // Initialize event listeners
              var events = ['start', 'end', 'error'];
              events.forEach(this._propagateEvent.bind(this));

              this._bindResult();
          },
          _accentChanged: function() {
              this.recognition.lang = this.accent;
          },
          _propagateEvent: function (eventName) {
              var that = this;

              this.recognition.addEventListener(eventName, function(e) {
                  that.fire(eventName, e);
              });
          },
          _bindResult: function() {
              var that = this;

              this.recognition.addEventListener('result', function(e) {
                  for (var i = e.resultIndex; i < e.results.length; ++i) {
                      that.text += e.results[i][0].transcript;
                      e.result = that.text;
                  }

                  that.fire('result', e);
              });
          },
          start: function() {
              this.recognition.start();
          },
          stop: function() {
              this.recognition.stop();
          },
          abort: function() {
              this.recognition.abort();
          }
      });
  </script>
</dom-module>
